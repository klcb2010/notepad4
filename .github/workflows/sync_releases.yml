name: Sync Upstream Releases

on:
  schedule:
    - cron: "0 3 * * *"  # 每天早上 3 点自动执行（UTC 时间，可按需修改）
  workflow_dispatch:      # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Sync releases from upstream
        env:
          UPSTREAM: zufuliu/notepad4
          DOWNSTREAM: klcb2010/notepad4
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Fetching releases from $UPSTREAM ..."
          releases=$(curl -s https://api.github.com/repos/$UPSTREAM/releases)

          echo "$releases" | jq -r '.[] | [.tag_name, .name, .body, .draft, .prerelease, .assets[0].browser_download_url] | @tsv' |
          while IFS=$'\t' read -r tag name body draft prerelease asset; do
            echo "Processing tag: $tag"
            # 检查目标仓库是否已存在该 release
            exist=$(curl -s https://api.github.com/repos/$DOWNSTREAM/releases/tags/$tag | jq -r .tag_name)
            if [ "$exist" != "$tag" ]; then
              echo "Creating new release: $tag"
              json=$(jq -n --arg tag "$tag" --arg name "$name" --arg body "$body" \
                --argjson draft "$draft" --argjson prerelease "$prerelease" \
                '{tag_name:$tag, name:$name, body:$body, draft:$draft, prerelease:$prerelease}')
              upload_url=$(curl -s -X POST -H "Authorization: token $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/$DOWNSTREAM/releases \
                -d "$json" | jq -r .upload_url | sed 's/{?name,label}//')
              if [ -n "$asset" ] && [ "$asset" != "null" ]; then
                echo "Uploading asset..."
                filename=$(basename "$asset")
                curl -sL "$asset" -o "$filename"
                curl -s -X POST -H "Authorization: token $GH_TOKEN" \
                  -H "Content-Type: application/octet-stream" \
                  --data-binary @"$filename" \
                  "$upload_url?name=$filename" > /dev/null
                echo "✅ Uploaded: $filename"
              fi
            else
              echo "Already exists: $tag"
            fi
          done
