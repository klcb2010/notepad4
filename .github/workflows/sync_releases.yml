name: Sync Last 2 zh-Hans Assets (Safe)

on:
  schedule:
    - cron: "0 3 * * *"   # æ¯å¤©å‡Œæ™¨3ç‚¹ UTC
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl gh

      - name: Authenticate GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: Fetch latest release from upstream
        id: fetch
        run: |
          echo "ğŸ” Fetching latest release from zufuliu/notepad4 ..."
          curl -s https://api.github.com/repos/zufuliu/notepad4/releases/latest > upstream.json
          TAG=$(jq -r .tag_name upstream.json)
          NAME=$(jq -r .name upstream.json)
          BODY=$(jq -r .body upstream.json)
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "NAME=$NAME" >> $GITHUB_ENV
          echo "$BODY" > release_body.md

      - name: Check if release already exists
        id: check_release
        run: |
          if gh release view ${{ env.TAG }} --repo klcb2010/notepad4 > /dev/null 2>&1; then
            echo "EXISTS=true" >> $GITHUB_ENV
          else
            echo "EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Create release if not exists
        if: env.EXISTS == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.NAME }}
          body_path: release_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload last 2 zh-Hans assets safely
        run: |
          # æ£€æŸ¥ assets æ˜¯å¦å­˜åœ¨
          HAS_ASSETS=$(jq '.assets != null and (.assets | length > 0)' upstream.json)
          if [ "$HAS_ASSETS" != "true" ]; then
            echo "âš ï¸ No assets found in upstream release, skipping upload."
            exit 0
          fi

          # è·å–æ‰€æœ‰ zh-Hans æ–‡ä»¶
          ASSETS=$(jq -r '.assets[].browser_download_url' upstream.json | grep "zh-Hans" || true)
          if [ -z "$ASSETS" ]; then
            echo "âš ï¸ No zh-Hans assets found, skipping upload."
            exit 0
          fi

          # åªå–æœ€åä¸¤ä¸ª
          LAST2=$(echo "$ASSETS" | tail -n 2)

          for URL in $LAST2; do
            FILE=$(basename "$URL")
            echo "â¬‡ï¸ Downloading $FILE ..."
            curl -sSL "$URL" -o "$FILE"
            
            # ä¸Šä¼ æ–‡ä»¶ï¼Œå¦‚æœå·²å­˜åœ¨å°±è·³è¿‡
            if gh release upload ${{ env.TAG }} "$FILE" --repo klcb2010/notepad4 --clobber=false 2>/dev/null; then
              echo "âœ… $FILE uploaded successfully"
            else
              echo "âš ï¸ $FILE already exists, skipping"
            fi

            # åˆ é™¤æœ¬åœ°ä¸‹è½½æ–‡ä»¶
            rm -f "$FILE"
          done
